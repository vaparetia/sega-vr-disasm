digraph KeyFunctions {
  rankdir=TB;
  node [shape=box, fontname="Courier"];
  edge [color="#666666"];

  // Subgraph: Boot & Init
  subgraph cluster_boot {
    label="Boot & Init";
    style=filled;
    color=lightgrey;

    entry_point [label="$000200\nentry_point" style=filled fillcolor="#FFD700"];
    adapter_init [label="$000838\nadapter_init"];
    warm_boot_init [label="$000D68\nwarm_boot_init"];
  }

  // Subgraph: V-INT Handler
  subgraph cluster_vint {
    label="V-INT Handler";
    style=filled;
    color="#E6F3FF";

    vint_handler [label="$001684\nvint_handler" style=filled fillcolor="#87CEEB"];
    vint_state_common [label="$0019FE\nvint_state_common"];
    vint_state_fb_toggle [label="$001C66\nvint_state_fb_toggle"];
    poll_controllers [label="$00179E\npoll_controllers"];
  }

  // Subgraph: SH2 Communication
  subgraph cluster_sh2 {
    label="SH2 Communication";
    style=filled;
    color="#FFE6E6";

    sh2_send_cmd_wait [label="$00E316\nsh2_send_cmd_wait" style=filled fillcolor="#FF6B6B"];
    sh2_wait_response [label="$00E342\nsh2_wait_response"];
    sh2_graphics_cmd [label="$00E22C\nsh2_graphics_cmd"];
    sh2_cmd_27 [label="$00E3B4\nsh2_cmd_27\n(21 calls)"];
    sh2_frame_sync [label="$00203A\nsh2_frame_sync"];
    sh2_comm_sync [label="$002890\nsh2_comm_sync"];
  }

  // Subgraph: VDP/Display
  subgraph cluster_vdp {
    label="VDP & Display";
    style=filled;
    color="#E6FFE6";

    VDPSyncSH2 [label="$0028C2\nVDPSyncSH2"];
    VDPFill [label="$0027F8\nVDPFill"];
    unpack_tiles_vdp [label="$00247C\nunpack_tiles_vdp\n(24 calls)"];
    vdp_reg_write [label="$003126\nvdp_reg_write"];
  }

  // Subgraph: Game Logic
  subgraph cluster_game {
    label="Game Logic";
    style=filled;
    color="#FFF0E6";

    game_logic_entry [label="$006200\ngame_logic_entry"];
    state_machine [label="$00961E\nstate_machine"];
    game_update [label="$009802\ngame_update"];
    physics_calc [label="$009B54\nphysics_calc"];
    object_update [label="$00B684\nobject_update"];
  }

  // Subgraph: Object System
  subgraph cluster_objects {
    label="Object System";
    style=filled;
    color="#F0E6FF";

    angle_to_sine [label="$0070AA\nangle_to_sine\n(29 calls)" style=filled fillcolor="#DDA0DD"];
    load_object_params [label="$0080CC\nload_object_params\n(27 calls)"];
    object_frame_timer [label="$008170\nobject_frame_timer\n(22 calls)"];
    calc_steering [label="$006F98\ncalc_steering\n(19 calls)"];
    obj_velocity_x [label="$007F50\nobj_velocity_x\n(18 calls)"];
  }

  // Subgraph: Sound
  subgraph cluster_sound {
    label="Sound System";
    style=filled;
    color="#FFFDE6";

    sound_init [label="$00D1D4\nsound_init"];
    fm_write [label="$0014BE\nfm_write"];
    z80_bus_request [label="$030D1C\nz80_bus_request"];
  }

  // Subgraph: Master Sequencer
  subgraph cluster_seq {
    label="Master Sequencer";
    style=filled;
    color="#E6FFFE";

    master_sequencer [label="$00C200\nmaster_sequencer"];
    scene_transition [label="$00C870\nscene_transition"];
  }

  // Key relationships
  entry_point -> adapter_init;
  entry_point -> game_logic_entry;

  vint_handler -> vint_state_common;
  vint_handler -> vint_state_fb_toggle;
  vint_handler -> poll_controllers;

  game_logic_entry -> state_machine;
  state_machine -> game_update;
  game_update -> physics_calc;
  game_update -> object_update;

  object_update -> angle_to_sine;
  object_update -> load_object_params;
  object_update -> object_frame_timer;
  physics_calc -> calc_steering;
  physics_calc -> obj_velocity_x;

  vint_state_fb_toggle -> VDPSyncSH2;
  VDPSyncSH2 -> sh2_comm_sync;

  master_sequencer -> scene_transition;
  master_sequencer -> sh2_graphics_cmd;

  sh2_graphics_cmd -> sh2_send_cmd_wait;
  sh2_cmd_27 -> sh2_send_cmd_wait;
  sh2_send_cmd_wait -> sh2_wait_response;

  game_update -> sh2_frame_sync;

  sound_init -> fm_write;
  fm_write -> z80_bus_request;
}
